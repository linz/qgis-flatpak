name: Build and Push Flatpak

on:
  push:
    branches:
      - master

permissions:
  contents: write # Required to push the built repo back to the branch

jobs:
  flatpak-build:
    runs-on: ubuntu-latest_16core
    container:
      image: ghcr.io/flathub-infra/flatpak-github-actions:gnome-48
      options: --privileged

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Fix Git Trust
        run: git config --global --add safe.directory '/__w/qgis-flatpak/*'

      - name: Cache Flatpak dependencies
        uses: actions/cache@v4
        with:
          path: .flatpak-builder
          key: flatpak-builder-${{ hashFiles('modules/*.json') }}
          restore-keys: |
            flatpak-builder-

      - name: Bundle info
        run: |
          QGIS_COMMIT=$(jq -r '.modules[] | select(objects | .name == "qgis") | .sources[0].commit' nz.govt.linz.qgis.json)
          SHORT_QGIS=${QGIS_COMMIT:0:6}
          CURRENT_COMMIT=$(git rev-parse --short=6 HEAD)
          BUILD_ID=${{github.run_number}}
          ID="linz-qgis_${SHORT_QGIS}-${CURRENT_COMMIT}_build-${BUILD_ID}"
          echo "build_id=${ID}" >> $GITHUB_OUTPUT
        id: bundle_info

      - name: Setup Flathub Remote
        run: |
          flatpak remote-add --if-not-exists --user flathub https://flathub.org/repo/flathub.flatpakrepo

      - name: Install Build Dependencies
        run: |
          rm -rf build-dir
          dbus-run-session flatpak-builder --force-clean --disable-rofiles-fuse --user --install-deps-from=flathub --install-deps-only --state-dir=.flatpak-builder build-dir nz.govt.linz.qgis.json

      - name: Download Sources
        run: |
           dbus-run-session flatpak-builder --force-clean --download-only --state-dir=.flatpak-builder build-dir nz.govt.linz.qgis.json

      - name: Build Group 1 - Foundation Libraries
        run: |
           dbus-run-session flatpak-builder --force-clean --disable-rofiles-fuse --user --stop-at=spatialite --state-dir=.flatpak-builder build-dir nz.govt.linz.qgis.json

      - name: Build Group 2 - Database & Storage
        run: |
           dbus-run-session flatpak-builder --force-clean --disable-rofiles-fuse --user --stop-at=gdal --state-dir=.flatpak-builder build-dir nz.govt.linz.qgis.json

      - name: Build Group 3 - Qt Libraries
        run: |
           dbus-run-session flatpak-builder --force-clean --disable-rofiles-fuse --user --stop-at=qscintilla --state-dir=.flatpak-builder build-dir nz.govt.linz.qgis.json

      - name: Build Group 4 - Python Core
        run: |
           dbus-run-session flatpak-builder --force-clean --disable-rofiles-fuse --user --stop-at=python-setuptools --state-dir=.flatpak-builder build-dir nz.govt.linz.qgis.json

      - name: Build Group 5 - Python Geospatial
        run: |
           dbus-run-session flatpak-builder --force-clean --disable-rofiles-fuse --user --stop-at=python-psycopg2 --state-dir=.flatpak-builder build-dir nz.govt.linz.qgis.json

      - name: Build Group 6 - GRASS GIS
        run: |
           dbus-run-session flatpak-builder --force-clean --disable-rofiles-fuse --user --stop-at=gisgrass --state-dir=.flatpak-builder build-dir nz.govt.linz.qgis.json

      - name: Build Group 7 - Python Templates & Additional
        run: |
           dbus-run-session flatpak-builder --force-clean --disable-rofiles-fuse --user --stop-at=Draco --state-dir=.flatpak-builder build-dir nz.govt.linz.qgis.json

      - name: Build Group 8 - QGIS Main
        run: |
           dbus-run-session flatpak-builder --force-clean --disable-rofiles-fuse --user --stop-at=env-python --state-dir=.flatpak-builder build-dir nz.govt.linz.qgis.json

      - name: Finalize Build
        run: |
           dbus-run-session flatpak-builder --disable-rofiles-fuse --user --repo=repo --finish-only --state-dir=.flatpak-builder build-dir nz.govt.linz.qgis.json

      - name: Create Bundle
        run: |
          flatpak build-bundle repo ${BUILD_NAME}.flatpak nz.govt.linz.qgis
        env:
          BUILD_NAME: ${{ steps.bundle_info.outputs.build_id }}

      - name: Upload Bundle
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.bundle_info.outputs.build_id }}
          path: ${{ steps.bundle_info.outputs.build_id }}.flatpak

      - name: Generate Release Tag
        id: tag
        run: |
          echo "release_tag=$(date +'%Y-%m-%d')-$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Create Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create ${{ steps.tag.outputs.release_tag }} \
            --title "Release ${{ steps.tag.outputs.release_tag }}" \
            --generate-notes \
            ${{ steps.bundle_info.outputs.build_id }}.flatpak
