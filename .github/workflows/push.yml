name: Build and Push Flatpak

on:
  push:

permissions:
  contents: write # Required to push the built repo back to the branch

jobs:
  flatpak-build:
    runs-on: ubuntu-latest_16core
    container:
      image: ghcr.io/flathub-infra/flatpak-github-actions:gnome-48
      options: --privileged

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cache Flatpak dependencies
        uses: actions/cache@v4
        with:
          path: .flatpak-builder
          key: flatpak-builder-${{ hashFiles('nz.govt.linz.qgis.json', 'modules/*.json') }}
          restore-keys: |
            flatpak-builder-

      - name: Setup Flathub Remote
        run: |
          flatpak remote-add --if-not-exists --user flathub https://flathub.org/repo/flathub.flatpakrepo

      - name: Install Build Dependencies
        run: |
          dbus-run-session flatpak-builder --disable-rofiles-fuse --user --install-deps-from=flathub --install-deps-only --state-dir=.flatpak-builder build-dir nz.govt.linz.qgis.json

      - name: Download Sources
        run: |
          flatpak-builder --download-only --state-dir=.flatpak-builder build-dir nz.govt.linz.qgis.json

      - name: Build Group 1 - Foundation Libraries
        run: |
          flatpak-builder --disable-rofiles-fuse --user --stop-at=spatialite --state-dir=.flatpak-builder build-dir nz.govt.linz.qgis.json

      - name: Build Group 2 - Database & Storage
        run: |
          flatpak-builder --disable-rofiles-fuse --user --stop-at=gdal --state-dir=.flatpak-builder build-dir nz.govt.linz.qgis.json

      - name: Build Group 3 - Qt Libraries
        run: |
          flatpak-builder --disable-rofiles-fuse --user --stop-at=qscintilla --state-dir=.flatpak-builder build-dir nz.govt.linz.qgis.json

      - name: Build Group 4 - Python Core
        run: |
          flatpak-builder --disable-rofiles-fuse --user --stop-at=python-setuptools --state-dir=.flatpak-builder build-dir nz.govt.linz.qgis.json

      - name: Build Group 5 - Python Geospatial
        run: |
          flatpak-builder --disable-rofiles-fuse --user --stop-at=python-psycopg2 --state-dir=.flatpak-builder build-dir nz.govt.linz.qgis.json

      - name: Build Group 6 - GRASS GIS
        run: |
          flatpak-builder --disable-rofiles-fuse --user --stop-at=gisgrass --state-dir=.flatpak-builder build-dir nz.govt.linz.qgis.json

      - name: Build Group 7 - Python Templates & Additional
        run: |
          flatpak-builder --disable-rofiles-fuse --user --stop-at=Draco --state-dir=.flatpak-builder build-dir nz.govt.linz.qgis.json

      - name: Build Group 8 - QGIS Main
        run: |
          flatpak-builder --disable-rofiles-fuse --user --stop-at=env-python --state-dir=.flatpak-builder build-dir nz.govt.linz.qgis.json

      - name: Finalize Build
        run: |
          flatpak-builder --disable-rofiles-fuse --user --repo=repo --finish-only --state-dir=.flatpak-builder build-dir nz.govt.linz.qgis.json

      - name: Create Bundle
        run: |
          QGIS_COMMIT=$(jq -r '.modules[] | select(.name == "qgis") | .sources[0].commit' nz.govt.linz.qgis.json)
          flatpak build-bundle repo linz-qgis_${QGIS_COMMIT}.flatpak nz.govt.linz.qgis

      - name: Upload Bundle Artifact
        run: |
          QGIS_COMMIT=$(jq -r '.modules[] | select(objects | .name == "qgis") | .sources[0].commit' nz.govt.linz.qgis.json)
          echo "artifact_name=linz-qgis_${QGIS_COMMIT}" >> $GITHUB_OUTPUT
        id: bundle_info

      - name: Upload Bundle
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.bundle_info.outputs.artifact_name }}
          path: linz-qgis_*.flatpak
